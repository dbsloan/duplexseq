# duplexseq
Scripts for analysis of duplex sequencing data


## Overview

The scripts in this repository are used for processing of raw reads generated by [the duplex sequencing method](https://www.nature.com/articles/nprot.2014.170) and subsequent variant calling and characterization. All code is in the `scripts` subdirectory. Some example files to help with formatting are in the `example_files` subdirectory.

## Dependencies

- [BBMerge](https://jgi.doe.gov/data-and-tools/bbtools/bb-tools-user-guide/bbmerge-guide/)
- [cutadapt](https://cutadapt.readthedocs.io/en/stable/)
- [bowtie2](http://bowtie-bio.sourceforge.net/bowtie2/index.shtml)
- [NCBI BLAST+](https://blast.ncbi.nlm.nih.gov/Blast.cgi?CMD=Web&PAGE_TYPE=BlastDocs&DOC_TYPE=Download) 
- [sloan.pm Perl module](https://github.com/dbsloan/perl_modules)
- Perl
- Python3 (if using a k-mer database to screen variants with `duplexseq_sam_to_indels.pl` or `duplexseq_sam_to_snps.pl`)

These scripts have been developed and run in a Linux CentOS6 environment, but we anticipate that they will work in most Linux environments.

## Pipeline Summary

**Raw read processing and filtering of read family consensus sequence**
- [`duplexseq_process_reads.pl`](https://github.com/dbsloan/duplexseq#duplexseq_process_readspl)
- [`duplexseq_family_filter_and_trim.pl`](https://github.com/dbsloan/duplexseq#duplexseq_family_filter_and_trimpl)

**Mapping to reference genome**
- `bowtie2`

**Raw variant calling**
- [`duplexseq_sam_to_indels.pl`](https://github.com/dbsloan/duplexseq#duplexseq_sam_to_indelspl)
- [`duplexseq_sam_to_snps.pl`](https://github.com/dbsloan/duplexseq#duplexseq_sam_to_snpspl)

**Aggregating data from multiple libraries, variant filtering, and summary**
- [`duplexseq_indels_post_processing.pl`](https://github.com/dbsloan/duplexseq#duplexseq_indels_post_processingpl)
- [`duplexseq_snps_post_processing.pl`](https://github.com/dbsloan/duplexseq#duplexseq_snps_post_processingpl)
- [`duplexseq_coverage_summary.pl`](https://github.com/dbsloan/duplexseq#duplexseq_coverage_summarypl)

**Other scripts**
- [`duplexseq_batchscripts.pl`](https://github.com/dbsloan/duplexseq#duplexseq_batchscriptspl) (generates a shell script for each input library to automate the first 3 steps above under our standard parameters)
- `duplexseq_indels_kmercount.py` and `duplexseq_snps_kmercount.py` (accessory scripts called during SNP and indel post-processing if using a k-mer database)
- [`duplexseq_snp_classification.pl`](https://github.com/dbsloan/duplexseq#duplexseq_snp_classificationpl) (functional annotation of filtered SNP calls)

## duplexseq_batchscripts.pl

This script is called with a single input:

`perl duplexseq_batchscripts.pl input_files.txt`

Where `input_files.txt` is a tab-delimited file with one row for each input library and four columns. The first column is a library name that will be applied to all output files. The second and third columns are read 1 and read 2 fastq files, respectively (gzipped is ok). The fourth column is the name of a fasta file with a corresponding bowtie2 database to be used in mapping. See `example_files/input_files.txt`. The output is one shell script for each input library, which are formatted for submission to a standard Slurm-based Linux queuing system and contain the commands to automate read processing, filtering, mapping, and raw variant calling. It assumes the other duplexseq scripts are installed and in your PATH.

## duplexseq_process_reads.pl

This script processes raw fasta inputs to generate single-stranded consensus sequence (SSCS) families and double-stranded consensus sequence (DCS) families. It can be run directly or with the scripts generated by `duplexseq_batchscripts.pl` (see above). Usage instructions for calling it directly are as follows.

`perl duplexseq_process_reads.pl [options/arguments]`

   REQUIRED ARGUMENTS
   
   R1 Fastq File

         --r1_fastq
         File containing Illumina read 1 sequences. Can be gzipped.
   
   R2 Fastq File

         --r2_fastq
         File containing Illumina read 2  sequences. Can be gzipped.

   Output Name
   
         --output
         Base name for all output files (additional extensions will be added)
   
   
   OPTIONAL ARGUMENTS
 
   Minimum SSCS Family Size
   
         --min_sscs [default: 3]
         Minimum number of reads in a family to generate a single-stranded consensus sequence 

   Minimum agreement to call SSCS base
   
         --min_agree [default: 0.8]
         Proportion of reads within a read family that must agree to make an SSCS base call. 

   Minimum SSCS applied to only one strand
   
         --min_sscs_one_strand [default: off]      
         Add this flag if min SSCS read number is only required for one of the
         two complementary read families (i.e., a double-stranded consensus can 
         be built with only a single read in the complementary family).

   Cutadapt Executable
   
         --cutadapt_exe [default: cutadapt]      
         Full path to cutadapt if not in default PATH

   Cutadapt R1 Adapter
   
         --cutadapt_adap1 [default: AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC]   
         Adapter sequences to trim from read 1

   Cutadapt R2 Adapter
   
         --cutadapt_adap2 [default: AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT]   
         Adapter sequences to trim from read 2

   Cutadapt Error Tolerance
   
         --cutadapt_err_tol [default: 0.15]   
         Error tolerance for cutadapt trimming

   Cutadapt Cores
   
         --cutadapt_cores [default: 4]   
         Number of cores to request for cutadapt step. This may need to be set
         to 1 if using a cutadapt version with Python v2.

   Cutadapt Minimum Length
   
         --cutadapt_min_len [default: 75]   
         Value for minimum_length parameter in cutadapt

   Cutadapt Quality Score for Trimming
   
         --cutadapt_trimq [default: 20]   
         Quality score used for q parameter in cutadapt
         
   Turn Off Cutadapt Trimming
   
         --disable_cutadapt 
         Add this flag to turn off primer trimming with cutadapt.

   BBmerge Executable
   
         --bbmerge_exe [default: bbmerge.sh]      
         Full path to bbmerge.sh if not in default PATH
         
   BBmerge Minimum Overlap
   
         --bbmerge_minoverlap [default: 30]   
         Sequence length for minoverlap parameter in bbmerge.sh

   BBmerge Mismatches
   
         --bbmerge_mismatches [default: 5]   
         Maximum number of mismathces for mismatches parameter in bbmerge.sh
   
   Random Barcode Length
   
         --barcode_len [default: 12] 
         Number of Ns in the random barcode (unique molecular identifier) at
         beginning of each read.

   Linker Sequence
   
         --linker [default: TGACT] 
         Number of Ns in the random barcode (unique molecular identifier) at
         beginning of each read.
 
   Disable Repetitive Barcode Filter
   
    	--disable_rep_filter
    	Add this flag to turn off the default filter that excludes reads with
    	barcodes that are just one long homopolymer (e.g. AAAAAAAAAAAA).

   Disable Filtering of Barcodes with Ns

    	--disable_n_filter
    	Add this flag to turn off the default filter that excludes reads with
    	barcodes that contain an N.

   Exclude Reads with Low Barcode Quality
    
    	--min_barcode_qual [default: 20]
    	Discard reads that have basecalls in barcode with quality value lower
    	than this.
    	
   Illumina Phred Quality Score Version  
   
    	--phred_offset [default: 33]
    	ASCII offset value for quality score encoding. 33 is standard for
    	current Illumina runs.

   Delete Fastq Files
   
    	--delete_intermediate_fastqs
    	Add this flag to delete the large intermediate fastq files and only
    	save the final fasta consensus sequence files.

   Combine DCS Fasta Output Files
   
    	--combine_dcs
    	Add this flag to print all DCS output to a single fasta file
    	regardless of whether they were merged by bbmerge.

   Suppress SSCS Fasta Output Files
   
    	--suppress_sscs
    	Add this flag to avoid producing SSCS fasta output.

   Filtering Optical Duplicates    
   
    	--min_optical_dist [default: 0]
    	Minimum pixel distance for retaining a read with the same barcode as 
    	another read on the same tile within the same Illumina flow cell.
    	Specifying non-zero values here will help eliminate optical/clustering
    	duplicates.
                 

## duplexseq_family_filter_and_trim.pl

This script can be used to filter and trim SSCS and DCS data produced by `duplexseq_process_reads.pl` (see above). It can be run directly or with the scripts generated by `duplexseq_batchscripts.pl` (see above). Usage instructions for calling it directly are as follows. Note that it contains options to trim read ends  or sequences that were not covered in the overlap regions between R1 and R2 paired sequences. But in our standard implementation, we only use it to remove consensus sequences that contain Ns (`--discard_n_reads`).

`perl duplexseq_family_filter_and_trim.pl [options/arguments]`
   
   
   REQUIRED ARGUMENTS
   
   Fasta File Input

         --input
         A fasta output file from duplexseq_process_reads.pl
   
   Output Name

         --output
         Name of new fasta file where output will be written
   
   
   OPTIONAL ARGUMENTS
   
   Unmerged Input

         --unmerged [default: off] 
         Add this flag if the input fasta is an unmmerged file.

   Trim Non-Overlap Regions

         --overlap_only [default: off]      
         Delete sequnece regions that were not in the overlap region of the
         merged read. This option is ignored if --unmerged is specified.

   Discard Reads with Ns

         --discard_n_reads [default: off] 
         Add this flag to exlude any read that contains an N.

   Trim Ligation Ends

         --endtrim [default: 0]      
         Remove this many bases from start of reads. For merged reads,
         this will be removed from both ends. For unmerged reads, only
         the 5' end will be trimmed.
        
   Minimum Length

         --min_len [default: 1]   
         Exclude reads shorter than this threshold after trimming steps are
         applied.
      
      
## duplexseq_sam_to_indels.pl

This script takes the SAM file produced by mapping SSCS or DCS data against a reference genome and identifies all simple indels (i.e., reads containing a single internal indel; more complex structural variants are not reported). It can be run directly or with the scripts generated by `duplexseq_batchscripts.pl` (see above). Usage instructions for calling it directly are as follows. Note that it has an option to report k-mer counts based on a reference database, but this is not recommended at this step. A more efficient implementation is available in `duplexseq_indels_post_processing.pl`.

`perl duplexseq_sam_to_indels.pl [options/arguments]`
   
   REQUIRED ARGUMENTS
   
   SAM File

         --sam
         File name of SAM output from bowtie2 mapping of DCS/SSCS sequences
         against a reference genome.
   
   Consensus Sequences Fasta File

         --seqs
         Fasta file containing DCS or SSCS reads from duplex sequencing.

   Output Name

         --output
         Base name for all output files (additional extensions will be added)


   OPTIONAL ARGUMENTS
  
   Excluded Reference Sequences

         --excluded_refs      
         Comma-delimited string of sequences within the reference fasta to exclude

   k-mer Database

         --kmer_db
         Database of k-mer counts as produced kmc_dump or similar program. Should
         be formated as a text file with one k-mer per line. Line format should
         be k-mer sequence followed by one white-space character followed by k-mer
         count. Counts of indentified variants will be reported. This feature may
         be useful for identifying contaminating sequences, such as apparent 
         mitochondrial variants that are actually derived from nuclear sequences 
         (i.e., numts). In this scenario the k-mer database might be generated
         from a standard shotgun library of total-cellular DNA.

   k-mer Size

         --kmer_size [default = 39]
         Size of k-mers. If a k-mer database is specified with --kmer_db to generate
         counts, this k-mer size must match the size used to generate the database
         with kmc or similar program.

## duplexseq_sam_to_snps.pl

This script takes the SAM file produced by mapping SSCS or DCS data against a reference genome and identifies all SNPs (i.e., reads containing a single base substitution relative to the reference; reads with multinucleotide variants are not reported). It can be run directly or with the scripts generated by `duplexseq_batchscripts.pl` (see above). Usage instructions for calling it directly are as follows. Note that it has an option to report k-mer counts based on a reference database, but this is not recommended at this step. A more efficient implementation is available in `duplexseq_snps_post_processing.pl`.

`perl duplexseq_sam_to_snps.pl [options/arguments]`

   REQUIRED ARGUMENTS
   
   SAM File

         --sam
         File name of SAM output from bowtie2 mapping of DCS/SSCS sequences
         against a reference genome.
   
   Consensus Sequences Fasta File

         --seqs
         Fasta file containing DCS or SSCS reads from duplex sequencing.

   Reference Genome Fasta

         --ref
         Fasta file containing genome sequence(s) used as reference for read
         mapping.

   Output Name

         --output
         Base name for all output files (additional extensions will be added)


   OPTIONAL ARGUMENTS
  
   Excluded Reference Sequences

         --excluded_refs      
         Comma-delimited string of sequences within the reference fasta to exclude

   k-mer Database

         --kmer_db
         Database of k-mer counts as produced kmc_dump or similar program. Should
         be formated as a text file with one k-mer per line. Line format should
         be k-mer sequence followed by one white-space character followed by k-mer
         count. Counts of indentified variants will be reported. More than one 
         database can be specified with a comma-delimited list. This feature may
         be useful for identifying contaminating sequences, such as apparent 
         mitochondrial variants that are actually derived from nuclear sequences 
         (i.e., numts). In this scenario the k-mer database might be generated
         from a standard shotgun library of total-cellular DNA.

   k-mer Size

         --kmer_size [default = 39]
         Size of k-mers. If a k-mer database is specified with --kmer_db to generate
         counts, this k-mer size must match the size used to generate the database
         with kmc or similar program.


## duplexseq_indels_post_processing.pl

This script takes an input file that contains a simple list of indel files generated by `duplexseq_sam_to_indels.pl`. See `example_files/indels.input.txt` for formatting. If the `--kmer_db` option is used, it will call `duplexseq_indels_kmercount.py`, which requires Python3. Note that `--recomb_check` option is not a robust implementation for indels, so all flagged variants should manually checked to assess whether they are compatible with recombination. An example of the input for the `--repeat_file` option is available at `example_files/AT_org_repeats.txt`. We recommend using `--min_read_pos` option to exclude variants from the very ends of reads because of high error rates in these positions.

`perl duplexseq_indels_post_processing.pl [options/arguments]`


   REQUIRED ARGUMENTS
   
   Input File List

         --input
         Name (and path if not in local directory) of file containing a list
         of indel output files from duplexseq_sam_to_indels.pl. There should be
         one file name per line, and the path should be included if the files
         are not in the same directory as the indel files. Alternatively, the
         --input_path option can be used to pre-append the same path to all
         file names.
   
   Output Name

         --output
         Name of output file
   
 
   OPTIONAL ARGUMENTS

   Path to Input Indel Files

         --input_path   
         If the SNP input files are not in the local directory and their full
         path is not specified in the file provided with the --input argument,
         then provide the path with this option. This should not be used if
         the list of file names already includes path information. It will not
         be applied to the location of the input list of filenames itself (that
         path should be provided as part of the --input option if necessary).
              
   Minimum Read Position

         --min_read_pos [default: 1]      
         This filter will exclude variants found near the ends of reads. For
         example, setting this parameter to 11 will effectively remove any 
         variants in the first or last 10 bps of a read. The deafult setting
         of 1 will not filter any variants.

   k-mer Database

         --kmer_db
         Database of k-mer counts as produced kmc_dump or similar program.
         Should be formated as a text file with one k-mer per line. Line
         format should be k-mer sequence followed by one white-space character
         followed by k-mer count. Counts of indentified variants will be
         reported. More than one database can be specified with a comma-
         delimited list. This feature may be useful for identifying
         contaminating sequences, such as apparent mitochondrial variants that
         are actually derived from nuclear sequences (i.e., numts). In this
         scenario, the k-mer database might be generated from a standard
         shotgun library of total-cellular DNA. Calling this option requires
         python3 be installed and in your PATH with that executable name. A 
         PERL-based implementation of k-mer counting is available in the
         initial SAM parsing part of the pipeline, but it is much slower and
         impractical with large k-mer databases.

   k-mer Database Path

         --kmer_db_path [default = ./ (current working directory)]
         Path to location of the datebase file name(s) specified with --kmer_db	

   k-mer Script

         --kmer_script [default: duplexseq_indels_kmercount.py]
         The external script that is called if the --k-mer_db option is
         specified. Provide full path and file name if it is not already in
         your local directory.
         
   k-mer Size

         --kmer_size [default = 39]
         Size of k-mers. If a k-mer database is specified with --kmer_db to
         generate counts, this k-mer size must match the size used to generate
         the database with kmc or similar program.

   Recombination Check File
 
         --recomb_check
         Fasta file with genome to be used to check for variants that might
         have been created by recombinaion between short, non-identical
         repeats rather than de novo mutations. This would typically be the
         reference fasta file used for mapping. A blast database for this
         fasta must also exist in the same location (generated with
         make_blast_db in the NCBI BLAST+ package). The NCBI BLAST+
         executables must be installed and in your PATH if this option is
         used. It is also requires BioPerl.

   Recombination Check E-value
 
         --recomb_evalue [default = 1e-10]
         The e-value threshold applied for BLAST searches in checking for
         variants resulting from recombination if the --recomb_check option is
         specified.

   Contamination Check File
 
         --contam_check
         Fasta file with sequences representing potential sources of
         contamination. If this option is specified, variants will be flagged
         if the entire duplex read has a perfect match to this database. A
         blast database for this fasta must also exist in the same location
         (generated with make_blast_db in the NCBI BLAST+ package). The NCBI
         BLAST+ executables must be installed and in your PATH if this option
         is used.

   Repeat File
 
         --repeat_file
         File describing repeat content in the genome to identify positions as
         repetitive and map them identical positions elsewhere in the genome.
         A tab-delimited list of start/end coordinates and orientation info.
         Note that with indels the mapping of positions can be ambiguous, so
         the reported positions should be treated as only approximate. For
         example, a deletion in a homopolymer can be mapped anywhere along the
         length of it.

   Minimum Repeat Length
 
         --min_rep_len [default = 100]
         The minimum length of a perfect repeat to be used in repeat mapping.
                

## duplexseq_snps_post_processing.pl

This script takes an input file that contains a simple list of SNP files generated by `duplexseq_sam_to_snps.pl`. See `example_files/snps.input.txt` for formatting. If the `--kmer_db` option is used, it will call `duplexseq_snps_kmercount.py`, which requires Python3. An example of the input for the `--repeat_file` option is available at `example_files/AT_org_repeats.txt`. We recommend using `--min_read_pos` option to exclude variants from the very ends of reads because of high error rates in these positions.

`perl duplexseq_snps_post_processing.pl [options/arguments]`

   REQUIRED ARGUMENTS
   
   Input File List

         --input
         Name (and path if not in local directory) of file containing a list
         of SNP output files from duplexseq_sam_to_snps.pl. There should be
         one file name per line, and the path should be included if the files
         are not in the same directory as the SNP files. Alternatively, the
         --input_path option can be used to pre-append the same path to all
         file names.
   
   Output Name

         --output
         Name of output file
   
 
   OPTIONAL ARGUMENTS

   Path to Input SNP Files

         --input_path   
         If the SNP input files are not in the local directory and their full
         path is not specified in the file provided with the --input argument,
         then provide the path with this option. This should not be used if
         the list of file names already includes path information. It will not
         be applied to the location of the input list of filenames itself (that
         path should be provided as part of the --input option if necessary).
              
   Minimum Read Position

         --min_read_pos [default: 1]      
         This filter will exclude variants found near the ends of reads. For
         example, setting this parameter to 11 will effectively remove any 
         variants in the first or last 10 bps of a read. The deafult setting
         of 1 will not filter any variants.

   k-mer Database

         --kmer_db
         Database of k-mer counts as produced kmc_dump or similar program.
         Should be formated as a text file with one k-mer per line. Line
         format should be k-mer sequence followed by one white-space character
         followed by k-mer count. Counts of indentified variants will be
         reported. More than one database can be specified with a comma-
         delimited list. This feature may be useful for identifying
         contaminating sequences, such as apparent mitochondrial variants that
         are actually derived from nuclear sequences (i.e., numts). In this
         scenario, the k-mer database might be generated from a standard
         shotgun library of total-cellular DNA. Calling this option requires
         python3 be installed and in your PATH with that executable name. A 
         PERL-based implementation of k-mer counting is available in the
         initial SAM parsing part of the pipeline, but it is much slower and
         impractical with large k-mer databases.

   k-mer Database Path

         --kmer_db_path [default = ./ (current working directory)]
         Path to location of the datebase file name(s) specified with --kmer_db	

   k-mer Script

         --kmer_script [default: duplexseq_snps_kmercount.py]
         The external script that is called if the --k-mer_db option is
         specified. Provide full path and file name if it is not already in
         your local directory.
         
   k-mer Size

         --kmer_size [default = 39]
         Size of k-mers. If a k-mer database is specified with --kmer_db to
         generate counts, this k-mer size must match the size used to generate
         the database with kmc or similar program.

   Recombination Check File

         --recomb_check
         Fasta file with genome to be used to check for variants that might
         have been created by recombinaion between short, non-identical
         repeats rather than de novo mutations. This would typically be the
         reference fasta file used for mapping. A blast database for this
         fasta must also exist in the same location (generated with
         make_blast_db in the NCBI BLAST+ package). The NCBI BLAST+
         executables must be installed and in your PATH if this option is
         used. It is also requires BioPerl.

   Recombination Check Flank

         --recomb_flank [default = 100]
         The amount of flanking sequence from the reference genome surrounding
         the variant that is used for searching for possible recombinants.
         This is only used if --recomb_check option is specified.

   Recombination Check E-value

         --recomb_evalue [default = 1e-10]
         The e-value threshold applied for BLAST searches in checking for
         variants resulting from recombination if the --recomb_check option is
         specified.

   Contamination Check File

         --contam_check
         Fasta file with sequences representing potential sources of
         contamination. If this option is specified, variants will be flagged
         if the entire duplex read has a perfect match to this database. A
         blast database for this fasta must also exist in the same location
         (generated with make_blast_db in the NCBI BLAST+ package). The NCBI
         BLAST+ executables must be installed and in your PATH if this option
         is used.

   Repeat File

         --repeat_file
         File describing repeat content in the genome to identify positions as
         repetitive and map them identical positions elsewhere in the genome.
         A tab-delimited list of start/end coordinates and orientation info.

   Minimum Repeat Length

         --min_rep_len [default = 100]
         The minimum length of a perfect repeat to be used in repeat mapping.


